---
title: "2019_41_Powerlifting"
author: "Jongseung John Lim"
date: "10/8/2019"
output: 
  html_document:
    theme: paper
    highlight: kate
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)

#install.packages("tidyverse")
devtools::install_github("dkahle/ggmap")
devtools::install_github("dr-harper/ggmapstyles")
#devtools::install_github("clauswilke/ggtext")
```

```{r prep, message=FALSE}
library(tidyverse)
library(ggtext)
library(gganimate)
library(gridExtra)
library(reshape2)
library(ghibli)
library(here)
source(here::here('R/utils/secrets.R'))
source(here::here('R/utils/utils.R'))
source(here::here("R/utils/custom_themes.R"))

theme_set(theme_custom(base_family="dosis"))
```

```{r data}
ipf_lifts <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-10-08/ipf_lifts.csv")

ipf_lifts <- ipf_lifts %>%
  mutate(date = substr(date, 1, 4))
```

```{r theme}
theme_update(rect = element_rect(fill = "grey10"),
          plot.title = element_markdown(size = 35,
                                    lineheight = 1.2,
                                    hjust = 0.5),
          plot.subtitle = element_markdown(size = 22, 
                                           color = "grey50", 
                                           hjust = 0,
                                           lineheight = 1.4),
          plot.caption = element_markdown(family = "dosis", 
                                          face = "bold",
                                          size = 18,
                                          color = "grey50"),
          axis.text.x = element_text(size = 14, 
                                     family = "Roboto Mono",
                                     color = "grey40"),
          axis.text.y = element_text(size = 14, 
                                     family = "Roboto Mono",
                                     color = "grey40"),
          axis.ticks.x = element_line(color = "grey30"),
          axis.ticks.y = element_blank(),
          strip.background = element_blank())
```

```{r pressure, echo=FALSE}
male <- subset(ipf_lifts, sex=="M") %>%
  mutate(date = substr(date, 1, 4) )
  
female <- subset(ipf_lifts, sex=="F") %>%
  mutate(date = substr(date, 1, 4) )


maleBestSquat <- male %>%
  group_by(date) %>%
  mutate(Rank = row_number(-best3squat_kg) * 1, 
         Value_rel = best3squat_kg/best3squat_kg[Rank==1],
         Value_lbl = paste0(" ", best3squat_kg)) %>%
  filter(Rank <= 10) %>%
  ungroup()

theme_set(theme_minimal(base_family="dosis"))

p <- ggplot(maleBestSquat, aes(Rank, group = name, fill = as.factor(name), color = as.factor(name)  )) +
  geom_tile(aes(y = best3squat_kg/2,
                height = best3squat_kg,
                width = 0.5), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(name, " ")), vjust = 0.2, hjust = 1.05) +
  geom_text(aes(y=best3squat_kg, label = Value_lbl, hjust=0)) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  labs(title='{closest_state}', x = "", y = "Squatting Weight (kg)",
       caption = "Sources: Open Powerlifting | Plot generated by John Lim") +
  theme(plot.title = element_text(hjust = 0, size = 22, face="bold"),
        axis.ticks.y = element_blank(),  # These relate to the axes post-flip
        axis.text.y  = element_blank(),  # These relate to the axes post-flip
        plot.margin = unit(c(1,1,1,5), "cm")) +
  transition_states(date, transition_length = 5, state_length = 10) +
  ease_aes('quadratic-in-out') + enter_fade() + exit_fade()

anim <- animate(p, fps = 30, duration = 30, width = 800, height = 600)
anim_save(here::here("plots/2019_41/2019_41_Powerlifting.gif"), anim)


#ggplot(male, aes(name, best3squat_kg)) + geom_point(alpha = 0.7, show.legend = FALSE) + facet_wrap( ~event) + labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +   transition_states(date, transition_length = 4, state_length = 1)

```

```{r scatterplot}
male <- subset(ipf_lifts, sex=="M") %>%
  mutate(date = as.numeric(substr(date, 1, 4) ) )
  
female <- subset(ipf_lifts, sex=="F") %>%
  mutate(date = as.numeric(substr(date, 1, 4) ) )


theme_set(theme_minimal(11, "dosis"))
theme_update(plot.title = element_markdown(hjust = 0, size = 22, face="bold"),
        plot.margin = margin(5,5,5,10, "mm"))

meltedmale <- melt(male, measure.vars = c("best3squat_kg", "best3bench_kg", "best3deadlift_kg"))
meltedmale <- subset(meltedmale, place == 1)

spm <- ggplot(meltedmale, aes(x=bodyweight_kg, y=value, color=variable, fill=variable)) + 
  geom_point( position = position_jitter(w = 1, h = 1)) +
  geom_smooth(aes(group=variable), method="loess", size=1, color="grey30") + 
  xlim(c(35, 200)) + 
  ylim(c(0, 500)) + 
  labs(subtitle="Male champions", 
       y="Lifting weight (kg)", 
       x="Body weight (kg)", 
       title="<img src='img/powerlifting.png' width='30'></img> Body Weight vs Lifting Performance in Power Lifting<br>") + 
  scale_colour_ghibli_d(name = "LaputaMedium", direction = -1, "Lifting cateogry" , labels= c("Sqauat", "Bench", "Deadlift")) + 
  scale_fill_ghibli_d(name = "LaputaMedium", direction = -1, "Lifting cateogry" , labels= c("Sqauat", "Bench", "Deadlift"))

meltedfemale <- melt(female, measure.vars = c("best3squat_kg", "best3bench_kg", "best3deadlift_kg"))
meltedfemale <- subset(meltedfemale, place == 1)
  
spf <- ggplot(meltedfemale, aes(x=bodyweight_kg, y=value, color=variable,  fill=variable)) + 
  geom_point( position = position_jitter(w = 1, h = 1)) +
   geom_smooth(aes(group=variable), method="loess", size=1, color="grey30") + 
  xlim(c(35, 200)) + 
  ylim(c(0, 500)) + 
  labs(subtitle="Female champions", 
       y="Lifting weight (kg)", 
       x="Body weight (kg)",  
       caption = "Source: Open Powerlifting | Visualization by John Lim") + 
  scale_colour_ghibli_d("PonyoMedium", direction = -1, "Lifting cateogry" , labels= c("Sqauat", "Bench", "Deadlift")) +
  scale_fill_ghibli_d(name = "PonyoDark", direction = -1, "Lifting cateogry" , labels= c("Sqauat", "Bench", "Deadlift"))

g <- arrangeGrob(spm, spf, layout_matrix = rbind(c(1), c(1), c(1), c(1), c(1), c(1),c(2) ,c(2) ,c(2),c(2),c(2)))

plot(g)
```

```{r saveplot}
ggsave(g, file = "plots/2019_41/2019_41_Powerlifting.png", width= 10.5, height = 9.5, type = "cairo", dpi = 96) # adjust dpi accordingly
ggsave(g, file = "plots/2019_41/2019_41_Powerlifting.pdf", width= 10.5, height = 9.5, device =cairo_pdf, dpi = 96) # adjust dpi accordingly

```
